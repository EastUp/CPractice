# <center>07.JNIEnv 的实现原理<center>
@[TOC](JNI基础)

**代码请看：`07.JNI基础-JNI Env 实现原理`**

# 知识点：

## 1. JNI 的一般开发流程：
1. 定义好本地的 native 方法
2. javah 命令生成 .h 头文件  `javah -d jni -jni com.east.NdkSample`
3. 拷贝 xxx.h、jni_md.h、jni.h 到 VS 的工程目录并添加依赖进来
4. 实现我们头文件中的 native 方法
5. 生成 dll 动态，java 引入 dll 动态库运行即可

## 2. 详解 .h 文件和实现文件

com_darren_ndk12_NdkSimple.h：

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include "jni.h"// "" 引入自己工程的头文件 <> 引入系统的头文件
/* Header for class com_darren_ndk12_NdkSimple */
// 用来打一个标记，c在编译的时候会把头文件 copy 到你引入的地方，不管是重复引用还是相互引用都只会 copy 一次
#ifndef _Included_com_darren_ndk12_NdkSimple
#define _Included_com_darren_ndk12_NdkSimple
#ifdef __cplusplus // 相当于 if 语句 c++ 
// 不管是 c 还是 c++ 统一都是采用 c 的编译方式，因为在c里面是不允许函数重载的,但是在 c++ 里面可以
extern "C" {
#endif
/*
 * Class:     com_darren_ndk12_NdkSimple
 * Method:    getSingnaturePassword
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_darren_ndk12_NdkSimple_getSingnaturePassword
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

Simple.c：

```c
// JNIEXPORT: JNI 一个关键字，不能少（编译能通过），标记为该方法可以被外部调用
// jstring : 代表 java 中的 String 
// JNICALL: 也是一个关键字，可以少的 jni call
// JNIEnv: 这个是 c 和 java 相互调用的桥梁，所有 function 搞清
// jobject: java传递下来的对象，就是本项目中 NdkSimple java 对象
// jclass: java传递下来的 class 对象，就是本项目中的 JniSimple.class（如果是静态方法才是jclass）
JNIEXPORT jstring JNICALL Java_com_darren_ndk12_NdkSimple_getSingnaturePassword
(JNIEnv * env, jobject jobj){
    // C 中 typedef const struct JNINativeInterface* JNIEnv; 已经是一个结构体指针了
    // C++ 中 typedef _JNIEnv JNIEnv; // 就是一个结构体

	// JNIEnv * 其实已经是一个二级指针了，所以 -> 调用的情况下必须是一级指针 *取值
	return (*env)->NewStringUTF(env,"940223");
}
```

## 3. JNIEnv 的实现原理

```c
#if defined(__cplusplus) // 如果是C++文件 
typedef _JNIEnv JNIEnv;    JNIEnv 就是结构体 _JNIEnv
typedef _JavaVM JavaVM;  
#else
typedef const struct JNINativeInterface* JNIEnv; // 如果是C文件 JNIEnv 是JNINativeInterface的一级指针
typedef const struct JNIInvokeInterface* JavaVM;
#endif
```
看下 `JNINativeInterface` 的部分代码：

```c
struct JNINativeInterface {
    void*       reserved0;
    void*       reserved1;
    void*       reserved2;
    void*       reserved3;

    jint        (*GetVersion)(JNIEnv *); // 函数指针
    ....
}
```

看下 `_JNIEnv` 的部分代码（调用的还是 `JNINativeInterface` 的方法）：

```c
struct _JNIEnv {
    /* do not rename this; it does not seem to be entirely opaque */
    const struct JNINativeInterface* functions;

#if defined(__cplusplus) // 如果是 C++ ，调用的还是 JNINativeInterface 的方法

    jint GetVersion()
    { return functions->GetVersion(this); }
    ...
#endif
}
```

## 4. C 中访问和修改 java 的属性和方法

获取类中：属性和方法签名：`javap -p -s com.darren.ndk12.NdkSimple1`

### 4.1 C中修改 java 的普通属性

java 中的属性：`public String name = "Eastrise";`

java 中的本地方法：`public native void changeName();`

c中的方法：

```c
JNIEXPORT void JNICALL Java_com_darren_ndk12_NdkSimple1_changeName
(JNIEnv *env, jobject jobj){
	// 获取 name 属性然后修改为 Jack

	// 3.获取 jclass 
	jclass j_clz = (*env)->GetObjectClass(env, jobj);
	// 获取 jfieldId (JNIEnv *env, jclass clazz, const char *name, const char *sig)
	// name 获取哪个属性的属性名 
	// 2.sig 属性的签名
	jfieldID j_fid = (*env)->GetFieldID(env, j_clz, "name", "Ljava/lang/String;");
	// 1.获取 name 属性的值
	jstring j_str = (*env)->GetObjectField(env, jobj, j_fid);

	// 打印字符串 jstring -> c_str
	char* c_str = (*env)->GetStringUTFChars(env,j_str,NULL);

	printf("name is %s",c_str);

	// 修改成 jack
	jstring jackName = (*env)->NewStringUTF(env,"Jack");
	(*env)->SetObjectField(env, jobj, j_fid, jackName);

}
```

### 4.2 C中修改 java 的静态属性

java 中的属性：`public static int age = 24;`

java 中的本地静态方法：`public static native void changeAge();`

c中的方法：

```c
JNIEXPORT void JNICALL Java_com_darren_ndk12_NdkSimple1_changeAge
(JNIEnv * env, jclass jcls){
	// 首先获取原来的

	jfieldID j_fid = (*env)->GetStaticFieldID(env,jcls,"age","I");
	// Static 获取静态的
	jint age = (*env)->GetStaticIntField(env, jcls, j_fid);

	// jint -> int
	age += 12;

	// 设置新的 age 参数
	(*env)->SetStaticIntField(env,jcls,j_fid,age);
}
```
### 4.3 c 调用 java 方法

java 中的方法：

```c
	public int add(int number1,int number2){
		return number1+number2;
	}
```

c中的方法：

```c

JNIEXPORT void JNICALL Java_com_darren_ndk12_NdkSimple1_callAddMathod
(JNIEnv *env, jobject jobj){
	
	jclass j_clz = (*env)->GetObjectClass(env,jobj);
	// 获取 methodid 
	jmethodID j_mid = (*env)->GetMethodID(env, j_clz, "add", "(II)I");
	// 去调用 java 的方法
	jint sum = (*env)->CallIntMethod(env, jobj, j_mid,2,3);

	printf("sum = %d",sum);
}
```







